<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rakun Agent</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-50 min-h-screen font-sans">
  <div class="max-w-3xl mx-auto p-8">
    <div class="flex items-center mb-12">
      <img src="/logo.svg" alt="Checkly Logo" class="h-11 mr-4">
      <div>
        <h1 class="text-3xl font-bold text-slate-900">Rakun Agent</h1>
      </div>
    </div>

    <p class="text-slate-600 text-lg mb-8">AI coding agent for creating pull requests in Rakun Design System.</p>

    <div class="bg-white rounded-2xl p-8 shadow-sm border border-slate-200">
      <form id="agent-form">
        <div class="mb-6">
          <label class="block font-semibold text-gray-700 mb-2" for="repo-url">Repository</label>
          <input type="text" id="repo-url" name="repoUrl" class="w-full p-4 border-2 border-gray-200 rounded-lg text-base bg-gray-50 text-gray-600 cursor-not-allowed" value="https://github.com/pmallol/rakun-agent"
            disabled readonly>
        </div>

        <div class="mb-6">
          <label class="block font-semibold text-gray-700 mb-2" for="prompt">What would you like the agent to do?</label>
          <textarea id="prompt" name="prompt" class="w-full min-h-[120px] p-4 border-2 border-gray-200 rounded-lg text-base resize-y transition-colors focus:outline-none focus:border-blue-500"
            placeholder="e.g., Update color tokens, create a new Story for a rakun component, Update the documentation with guidelines..."
            required></textarea>
        </div>

        <div class="mb-6">
          <label class="block font-semibold text-gray-700 mb-2">Upload CSS file (optional)</label>
          <div class="relative inline-block cursor-pointer w-full">
            <input type="file" id="css-file" name="cssFile" accept=".css" class="absolute opacity-0 w-full h-full">
            <label for="css-file" class="flex items-center justify-center p-12 border-2 border-dashed border-gray-300 rounded-lg transition-all bg-gray-50 hover:border-blue-500 hover:bg-blue-50">
              <div class="text-gray-600 text-sm">
                <div>üìÅ Click to upload CSS file</div>
                <div class="mt-2 text-xs">CSS files only</div>
              </div>
            </label>
          </div>
          <div id="file-name" class="mt-2 text-sm text-green-600 font-medium hidden"></div>
        </div>

        <button type="submit" class="w-full bg-blue-500 text-white border-0 p-4 rounded-lg text-base font-semibold cursor-pointer transition-colors mt-4 hover:bg-blue-600 disabled:bg-gray-400 disabled:cursor-not-allowed" id="submit-btn">
          Create Pull Request
        </button>
      </form>

      <div class="text-left my-4 text-gray-600 hidden" id="loading">
        <div class="inline-block w-5 h-5 border-2 border-gray-200 rounded-full border-t-blue-500 animate-spin mr-2"></div>
        Working on your request...
      </div>

      <div class="mt-8 p-4 rounded-lg hidden" id="result">
        <div id="result-message"></div>
        <a id="pr-link" class="inline-block mt-2 text-blue-500 no-underline font-medium hover:underline hidden" target="_blank"></a>
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById('agent-form');
    const submitBtn = document.getElementById('submit-btn');
    const loading = document.getElementById('loading');
    const result = document.getElementById('result');
    const resultMessage = document.getElementById('result-message');
    const prLink = document.getElementById('pr-link');
    const fileInput = document.getElementById('css-file');
    const fileName = document.getElementById('file-name');

    // File upload handling
    fileInput.addEventListener('change', function (e) {
      if (e.target.files.length > 0) {
        fileName.textContent = `Selected: ${e.target.files[ 0 ].name}`;
        fileName.classList.remove('hidden');
        fileName.classList.add('show-block');
      } else {
        fileName.classList.add('hidden');
        fileName.classList.remove('show-block');
      }
    });

    // Form submission
    form.addEventListener('submit', async function (e) {
      e.preventDefault();

      const prompt = document.getElementById('prompt').value;
      if (!prompt.trim()) {
        showResult('Please enter a prompt describing what you want the agent to do.', 'error');
        return;
      }

      // Show loading state
      submitBtn.disabled = true;
      loading.classList.remove('hidden');
      loading.classList.add('block');
      result.classList.add('hidden');
      result.classList.remove('block');

      try {
        const response = await fetch('/api/agent', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            prompt: prompt,
            repoUrl: 'https://github.com/pmallol/rakun-agent'
          })
        });

        const data = await response.json();

        if (response.ok) {
          showResult(data.response, 'success');
          if (data.prLink) {
            prLink.href = data.prLink;
            prLink.textContent = 'View Pull Request ‚Üí';
            prLink.classList.remove('hidden');
            prLink.classList.add('inline-block');
          }
        } else {
          showResult(`Error: ${data.error || 'Something went wrong'}`, 'error');
        }
      } catch (error) {
        showResult(`Network error: ${error.message}`, 'error');
      } finally {
        // Hide loading state
        submitBtn.disabled = false;
        loading.classList.add('hidden');
        loading.classList.remove('block');
      }
    });

    function showResult(message, type) {
      result.className = type === 'success' 
        ? 'mt-8 p-4 rounded-lg bg-green-50 border border-green-200 text-green-700 block' 
        : 'mt-8 p-4 rounded-lg bg-red-50 border border-red-200 text-red-700 block';
      result.classList.remove('hidden');
      resultMessage.textContent = message;

      if (type === 'error') {
        prLink.classList.add('hidden');
        prLink.classList.remove('inline-block');
      }
    }
  </script>
</body>
</html>